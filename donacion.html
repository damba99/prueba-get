<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pagar donaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>Don√°</h1>

  <label for="amount">Monto (PESOS ARS, solo enteros):</label>
  <input id="amount" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="1500" autocomplete="off" />
  <button type="button" id="btn">Pagar</button>

  <script>
    // üîß Cambi√° esto si us√°s otro backend
    const API = "https://getnet-volviendo-a-casa.onrender.com";

    // Solo d√≠gitos en el input (sin puntos, comas ni letras)
    const $amount = document.getElementById("amount");
    $amount.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, "");
    });

    function pickRedirectUrl(d) {
      const c = [
        d?.redirect_url, d?.payment_url, d?.processUrl, d?.url,
        d?.data?.links?.checkout, d?.data?.redirect_url, d?.data?.url
      ];
      return c.find(u => typeof u === "string" && u.startsWith("http")) || null;
    }

    async function createPaymentIntent() {
      const raw = $amount.value.trim();
      const pesos = parseInt(raw, 10);

      if (!Number.isInteger(pesos) || pesos <= 0) {
        alert("Ingres√° un monto v√°lido (pesos enteros, sin centavos).");
        $amount.focus();
        return;
      }

      // PESOS ‚Üí CENTAVOS para Getnet
      const amount = pesos * 100;
      if (!Number.isSafeInteger(amount)) {
        alert("Monto demasiado grande.");
        return;
      }

      // Abrir la pesta√±a antes del fetch para que no lo bloquee el navegador
      const win = window.open("about:blank", "_blank");
      const btn = document.getElementById("btn");
      const prev = btn.textContent;
      btn.disabled = true; btn.textContent = "Creando orden...";

      try {
        const res = await fetch(API + "/payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount }) // ‚Üê centavos
        });

        let data;
        try { data = await res.json(); } catch { data = await res.text(); }

        if (!res.ok) {
          if (win) win.close();
          alert("No se pudo crear la intenci√≥n de pago.\n" + (typeof data === "string" ? data : JSON.stringify(data, null, 2)));
          return;
        }

        const url = pickRedirectUrl(data);
        if (url) {
          if (win) win.location = url; else window.open(url, "_blank");
        } else {
          if (win) win.close();
          alert("La respuesta no incluy√≥ link de checkout.\n" + JSON.stringify(data, null, 2));
        }
      } catch (err) {
        if (win) win.close();
        alert("Error de red: " + err);
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    }

    document.getElementById("btn").addEventListener("click", createPaymentIntent);
  </script>
</body>
</html>
