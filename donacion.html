<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pagar donaci√≥n ‚Äî Fundaci√≥n Volviendo a Casa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 1rem; }
    form { max-width: 520px; margin: 0 auto; display: flex; flex-direction: column; gap: .75rem;
           background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    label { display: flex; flex-direction: column; font-size: .95rem; }
    input, select, button { padding: .5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #0074d9; color: #fff; border: none; cursor: pointer; font-weight: 600; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    small { color:#666; }
  </style>
</head>
<body>
  <h1>Don√° ‚Äî Fundaci√≥n Volviendo a Casa</h1>

  <form id="donationForm" onsubmit="return false;">
    <label>Monto (ARS)* <input id="amount" type="number" min="1" step="1" required placeholder="Ej: 1500" /></label>
    <label>Moneda*
      <select id="currency" required>
        <option value="ARS" selected>ARS (Pesos)</option>
        <option value="USD">USD (D√≥lares)</option>
        <option value="EUR">EUR (Euros)</option>
      </select>
    </label>

    <!-- Todos los dem√°s campos opcionales -->
    <label>Nombre <input id="first_name" /></label>
    <label>Apellido <input id="last_name" /></label>
    <label>Email <input id="email" type="email" /></label>
    <label>DNI / Doc <input id="document_number" /></label>
    <label>Tel√©fono <input id="phone_number" /></label>
    <label>Calle <input id="billing_street" /></label>
    <label>N√∫mero <input id="billing_number" /></label>
    <label>Ciudad <input id="billing_city" /></label>
    <label>Provincia <input id="billing_state" /></label>
    <label>CP <input id="billing_postal_code" /></label>

    <button id="btn" type="button">Pagar</button>
  </form>

  <script>
    const API = "http://localhost:3000"; // apuntando a tu backend local
    const startTime = Date.now();

    function pickRedirectUrl(d) {
      return d?.redirect_url || d?.payment_url || d?.processUrl || d?.url
          || d?.links?.checkout || d?.data?.redirect_url || d?.data?.links?.checkout
          || null;
    }

    async function createPaymentIntent() {
      const form = document.getElementById("donationForm");
      if (!form.reportValidity()) return;

      const pesos = parseInt(document.getElementById("amount").value.trim(), 10);
      if (!Number.isInteger(pesos) || pesos <= 0) {
        alert("Ingres√° un monto v√°lido en pesos.");
        return;
      }
      const amount = pesos * 100; // convertir a centavos

      const payload = {
        amount,
        currency: document.getElementById("currency").value,
        first_name: document.getElementById("first_name").value.trim(),
        last_name: document.getElementById("last_name").value.trim(),
        email: document.getElementById("email").value.trim(),
        document_number: document.getElementById("document_number").value.trim(),
        phone_number: document.getElementById("phone_number").value.trim(),
        billing_street: document.getElementById("billing_street").value.trim(),
        billing_number: document.getElementById("billing_number").value.trim(),
        billing_city: document.getElementById("billing_city").value.trim(),
        billing_state: document.getElementById("billing_state").value.trim(),
        billing_postal_code: document.getElementById("billing_postal_code").value.trim(),
        time_page: Math.round((Date.now() - startTime) / 1000),
      };

      console.log("üì¶ Payload al backend:", payload);

      const win = window.open("about:blank", "_blank");
      const btn = document.getElementById("btn");
      const prev = btn.textContent;
      btn.disabled = true; btn.textContent = "Creando orden...";

      try {
        const res = await fetch(API + "/payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        console.log("Respuesta backend:", data);
        const url = pickRedirectUrl(data);
        if (res.ok && url) {
          win.location = url;
        } else {
          win.close();
          alert("No se pudo crear la intenci√≥n de pago.\n" + JSON.stringify(data, null, 2));
        }
      } catch (e) {
        if (win) win.close();
        alert("Error al crear intenci√≥n: " + e.message);
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    }

    document.getElementById("btn").addEventListener("click", createPaymentIntent);
  </script>
</body>
</html>
