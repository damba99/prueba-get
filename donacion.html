<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pagar donación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>Doná</h1>

  <label for="amount">Monto (ARS, solo enteros):</label>
  <input 
    id="amount" 
    type="number" 
    inputmode="numeric" 
    pattern="[0-9]*" 
    min="1" 
    step="1" 
    placeholder="1500" 
    autocomplete="off" 
  />
  <button type="button" id="btn">Pagar</button>

  <script>
    const API = "https://getnet-volviendo-a-casa.onrender.com";
    const $amount = document.getElementById("amount");
    const $btn = document.getElementById("btn");

    // Normaliza posibles campos de URL devueltos
    function pickRedirectUrl(d) {
      const c = [
        d?.redirect_url, d?.payment_url, d?.processUrl, d?.url,
        d?.data?.links?.checkout, d?.data?.redirect_url, d?.data?.url
      ];
      return c.find(u => typeof u === "string" && u.startsWith("http")) || null;
    }

    async function getClientIp() {
      try {
        const r = await fetch("https://api.ipify.org?format=json");
        const j = await r.json();
        return j.ip || null;
      } catch {
        return null;
      }
    }

    async function createPaymentIntent() {
      const raw = $amount.value.trim();
      const pesos = parseInt(raw, 10);

      if (!Number.isInteger(pesos) || pesos <= 0) {
        alert("Ingresá un monto válido (pesos enteros, sin centavos).");
        $amount.focus();
        return;
      }

      const amount = pesos * 100;
      if (!Number.isSafeInteger(amount)) {
        alert("Monto demasiado grande.");
        return;
      }

      // Preabre ventana para no ser bloqueado
      const win = window.open("about:blank", "_blank");
      const prev = $btn.textContent;
      $btn.disabled = true; 
      $btn.textContent = "Creando orden...";

      try {
        const ip = await getClientIp();

        const payload = { amount };
        if (ip) payload.ip_address = ip; // se manda al backend

        const res = await fetch(API + "/payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data;
        try { data = await res.json(); } catch { data = await res.text(); }

        if (!res.ok) {
          if (win) win.close();
          alert("No se pudo crear la intención de pago.\n" + (typeof data === "string" ? data : JSON.stringify(data, null, 2)));
          return;
        }

        const url = pickRedirectUrl(data);
        if (url) {
          if (win) win.location = url; 
          else window.open(url, "_blank");
        } else {
          if (win) win.close();
          alert("La respuesta no incluyó link de checkout.\n" + JSON.stringify(data, null, 2));
        }
      } catch (err) {
        if (win) win.close();
        alert("Error de red: " + err);
      } finally {
        $btn.disabled = false; 
        $btn.textContent = prev;
      }
    }

    $btn.addEventListener("click", createPaymentIntent);
  </script>
</body>
</html>
